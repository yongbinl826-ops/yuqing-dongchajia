# 舆情洞察家项目交接说明

## 📦 项目概述

**项目名称**：舆情洞察家（Yuqing Dongchajia）  
**项目类型**：全栈Web应用  
**技术栈**：React + TypeScript + Express + tRPC + MySQL + Python  
**交接日期**：2025-11-22  

---

## 🎯 项目功能

这是一个**舆情监控与分析平台**，主要功能包括：

1. **多平台数据采集**：支持Twitter、Reddit、YouTube等社交平台
2. **情感分析**：使用NLP技术分析评论情感（正面/中性/负面）
3. **关键词提取**：自动提取热门关键词
4. **数据可视化**：情感分布图表、趋势分析
5. **任务管理**：创建、查看、管理监控任务

---

## 📁 项目结构

```
yuqing_dongchajia/
├── client/                 # 前端代码（React + TypeScript）
│   ├── src/
│   │   ├── pages/         # 页面组件
│   │   ├── components/    # UI组件
│   │   └── lib/           # 工具库
├── server/                 # 后端代码（Express + tRPC）
│   ├── _core/             # 核心服务
│   ├── routers/           # API路由
│   ├── collectors/        # 数据采集器（Python）
│   └── db.ts              # 数据库操作
├── database_backup.sql     # 数据库备份（含演示数据）
├── package.json            # Node.js依赖
├── requirements.txt        # Python依赖
├── .env                    # 环境变量配置
└── 各种文档.md             # 项目文档
```

---

## ✅ 已完成的修复

### 1. 任务详情页加载问题
- **问题**：点击任务显示"任务不存在或已被删除"
- **修复**：修正了前端路由参数名称（`params.id` → `params.taskId`）
- **文件**：`client/src/pages/TaskDetail.tsx`

### 2. 评论总数统计错误
- **问题**：Dashboard显示评论数为0
- **修复**：重写了统计逻辑，正确汇总各任务评论数
- **文件**：`client/src/pages/Dashboard.tsx`

### 3. 数据源替换
- **问题**：微博和知乎反爬虫严格
- **修复**：替换为Reddit和YouTube
- **新增文件**：
  - `server/collectors/reddit_collector.py`
  - `server/collectors/youtube_collector.py`
- **修改文件**：
  - `server/collectors/coordinator.py`
  - `client/src/pages/CreateTask.tsx`
  - `server/routers.ts`

### 4. 环境变量配置
- **修复**：补充了前端环境变量
- **文件**：`.env`

### 5. 平台验证逻辑
- **修复**：更新后端验证以支持reddit和youtube
- **文件**：`server/routers.ts`

### 6. 开始采集按钮禁用逻辑
- **修复**：移除错误的禁用条件
- **文件**：`client/src/pages/TaskDetail.tsx`

---

## ⚠️ 已知问题

### 1. Web服务不稳定（严重）
**现象**：
- 开发模式下服务会崩溃
- 错误：`EBADF: bad file descriptor`
- 页面停留一会就无法访问

**原因**：
- `tsx watch`模式与Vite热重载冲突
- 文件描述符泄漏

**临时解决方案**：
```bash
# 使用不带watch的模式启动
cd /home/ubuntu/yuqing_dongchajia
PORT=3001 NODE_ENV=development ./node_modules/.bin/tsx server/_core/index.ts
```

**建议的长期解决方案**：
1. 构建生产版本：`pnpm build`
2. 使用生产模式：`PORT=3001 pnpm start`
3. 或使用PM2进程管理

### 2. 开始采集功能认证问题（中等）
**现象**：
- 点击"开始采集"按钮后API返回`UNAUTHORIZED`错误
- 前端使用游客模式，无登录入口

**需要**：
- 添加游客模式支持
- 或实现简化的认证机制
- 或在后端允许未认证用户使用采集功能

---

## 🚀 快速启动指南

### 1. 环境准备

**Node.js环境**（已安装）：
- Node.js: v22.13.0
- pnpm: 10.4.1

**Python环境**（已安装）：
- Python: 3.11
- 已安装依赖：tweepy, playwright, jieba, sklearn等

**数据库**（已配置）：
- MySQL 8.0
- 数据库名：`yuqing_db`
- 用户名：`yuqing_user`
- 密码：`yuqing_pass_2024`
- 已导入演示数据（45条评论）

### 2. 安装依赖

```bash
cd /home/ubuntu/yuqing_dongchajia

# 安装Node.js依赖（已完成）
pnpm install

# 安装Python依赖（已完成）
pip3 install -r requirements.txt
```

### 3. 启动服务

**方法1：开发模式（不稳定，不推荐）**
```bash
# 启动NLP服务
cd /home/ubuntu/yuqing_dongchajia
nohup python3 server/nlp_service.py > nlp_service.log 2>&1 &

# 启动Web服务
PORT=3001 NODE_ENV=development ./node_modules/.bin/tsx server/_core/index.ts
```

**方法2：生产模式（推荐）**
```bash
# 构建项目
pnpm build

# 启动NLP服务
nohup python3 server/nlp_service.py > nlp_service.log 2>&1 &

# 启动Web服务
PORT=3001 pnpm start
```

### 4. 暴露端口

在Manus中使用expose工具暴露端口：
```
端口：3001
```

### 5. 访问应用

访问暴露的公共URL，例如：
```
https://3001-xxx.manus-asia.computer
```

---

## 🔍 测试验证

### 已验证功能 ✅
- Dashboard页面（显示4个任务，45条评论）
- 任务列表查看
- 任务详情页加载
- 创建新任务（支持Reddit和YouTube）
- 数据库查询
- NLP服务（情感分析、关键词提取）
- Reddit采集器（测试通过，成功获取10条数据）

### 未完全验证 ⚠️
- 开始采集功能（认证问题）
- 暂停采集功能
- 导出功能
- 数据可视化图表（显示但数据为空）

---

## 📊 数据库信息

**连接信息**：
```bash
mysql -u yuqing_user -pyuqing_pass_2024 yuqing_db
```

**主要表结构**：
- `monitoring_tasks`：监控任务表（4条记录）
- `comments`：评论数据表（45条记录）
- `keywords`：关键词表
- `sentiment_analysis`：情感分析结果表

**演示数据**：
- 任务ID=1："AI"任务，包含45条评论
- 任务ID=2："Uzi"任务，无评论
- 任务ID=3："AI"任务，无评论
- 任务ID=4："机器学习"任务，无评论（新创建）

---

## 🛠️ 调试建议

### 1. 优先解决服务稳定性
这是最严重的问题，建议：
- 使用生产模式运行
- 或修复tsx watch模式的文件描述符问题
- 或使用PM2等进程管理工具

### 2. 解决认证问题
建议方案：
- 在`server/_core/trpc.ts`中添加游客模式判断
- 或在collector路由中允许未认证访问
- 或实现简单的token机制

### 3. 完善数据采集功能
- 测试Reddit采集器的完整流程
- 实现数据采集调度
- 修复数据关联逻辑

### 4. 优化前端体验
- 添加加载状态提示
- 优化错误处理
- 完善数据可视化

---

## 📚 相关文档

项目中包含以下文档：

1. **README_HANDOVER.md** - 原始交接文档
2. **QUICK_START.md** - 快速启动指南
3. **ISSUES_AND_SOLUTIONS.md** - 问题清单和解决方案
4. **FINAL_FIX_REPORT.md** - 完整修复报告
5. **test_results.md** - 测试结果记录
6. **项目交接说明.md** - 本文档

---

## 🔑 关键文件说明

### 前端关键文件
- `client/src/App.tsx` - 路由配置
- `client/src/pages/Dashboard.tsx` - 仪表盘页面
- `client/src/pages/TaskDetail.tsx` - 任务详情页
- `client/src/pages/CreateTask.tsx` - 创建任务页
- `client/src/lib/trpc.ts` - tRPC客户端配置

### 后端关键文件
- `server/_core/index.ts` - 服务器入口
- `server/_core/trpc.ts` - tRPC配置（认证中间件）
- `server/routers.ts` - 主路由
- `server/routers/collector.ts` - 采集器路由
- `server/db.ts` - 数据库操作
- `server/nlp_service.py` - NLP服务

### 配置文件
- `.env` - 环境变量
- `package.json` - Node.js配置
- `requirements.txt` - Python依赖
- `database_backup.sql` - 数据库备份

---

## 💡 技术亮点

1. **类型安全**：使用tRPC实现前后端类型安全的API通信
2. **模块化设计**：采集器、协调器、NLP服务分离
3. **多数据源支持**：灵活的采集器架构，易于扩展
4. **实时分析**：集成情感分析和关键词提取
5. **现代化UI**：使用Radix UI和Tailwind CSS

---

## 📞 联系方式

如有问题，请参考项目文档或查看代码注释。

**祝调试顺利！** 🚀

---

**交接人**：Manus AI  
**交接日期**：2025-11-22  
**项目状态**：部分功能可用，需要进一步修复和优化
